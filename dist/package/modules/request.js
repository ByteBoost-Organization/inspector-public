"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RequestModule=void 0;const _1=require("."),eventBus_1=require("./eventBus");class RequestModule extends _1.BaseModule{persistantHeaders={};lastPostTimestamp=0;constructor(){super("request")}boot(){this.persistantHeaders={"X-Auth-Token":this.byteboost.getApiKey()},this.eventBus.listen(this.namespace,"get",async s=>{var e=await this.get(s.path),s=new eventBus_1.ByteEvent("","",{}).sharpen(s.event);s.setPayload(e),this.eventBus.dispatchEvent(s)}),this.eventBus.listen(this.namespace,"sync",async s=>{var e=await this.post(s.path,s.data.data),t=new eventBus_1.ByteEvent("","",{}).sharpen(s.event),e={response:e,responseTimestamp:Date.now(),data:s.data};t.setPayload(e),this.eventBus.dispatchEvent(t)})}isSuccessResponse(s){return 199<s&&s<300}async post(s,e){this.lastPostTimestamp=Date.now();try{var t=await fetch(s,{credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json",...this.persistantHeaders},method:"POST",body:JSON.stringify(e)});try{var a=await t.json();return this.isSuccessResponse(t.status)?{status:t.status,body:a,success:!0}:{status:t.status,body:a,success:!1}}catch(s){return this.isSuccessResponse(t.status)?{status:t.status,body:{},success:!0}:(this.byteboost.error("Unexpected post request error."),console.log(t.body,105),{status:t.status,body:t.body,success:!1})}}catch(s){return this.byteboost.error("Unexpected post request error."),{status:500,body:{},success:!1}}}async get(s){var s=await fetch(s,{credentials:"include",headers:{...this.persistantHeaders,Accept:"application/json"}}),e=await s.json();return this.isSuccessResponse(s.status)?{status:s.status,body:e,success:!0}:{status:s.status,body:e,success:!1}}build(){return{apiKey:""}}}exports.RequestModule=RequestModule;
