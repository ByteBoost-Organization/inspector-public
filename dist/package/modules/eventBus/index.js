"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EventBus=exports.ByteEvent=void 0;const object_1=require("package/utils/object"),__1=require("../"),__2=require("../../"),misc_1=require("../../misc"),middlewares_1=require("./middlewares"),toByteId=(e,t)=>e+":"+t,randomString=t=>{let s="";var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=n.length;for(let e=0;e<t;e++)s+=n.charAt(Math.floor(Math.random()*i));return s},generateEventId=e=>`${e}|${Date.now()}|`+randomString(8);class ByteEvent{id;payload;eventId;_meta={dispatched:-1};delay;when;priority=0;constructor(e,t,s,n){e=toByteId(e,t);this.when=Date.now(),this.id=e,this.payload=s,this.eventId=generateEventId(e),this.delay={waited:0,toWait:0,lastPoll:0},n&&(this.priority=n)}isValid(){return!!(this.id&&this.payload&&this.delay&&this.eventId)}setPayload(e){this.payload=e}sharpen(e){return this.id=e.id,this.eventId=e.eventId,this.payload=e.payload,this.delay=e.delay,this._meta=e._meta,this.priority=e.priority,this.when=e.when,this}flatten(){return{id:this.id,payload:(0,object_1.cloneObject)(this.payload),delay:this.delay,_meta:this._meta,eventId:this.eventId,priority:this.priority,when:this.when}}wait(e){return this.delay.lastPoll=Date.now(),this.delay.toWait=e,this}copy(){return new ByteEvent("","",{}).sharpen(this.flatten())}}exports.ByteEvent=ByteEvent;class EventBus extends __1.BaseDataModule{polling=!1;middlewares={before:[useValidEvents,...middlewares_1.beforeMiddlewares],after:[]};modulesToPoll=[];_poll;_garbage={events:[],eventsStr:[]};constructor(){super("eventBus"),this._poll={current:{id:0,timeout:1e3}},this.syncPathName=this.namespace.toLowerCase()}toByteId(e,t){return toByteId(e,t)}dispatch(e,t,s){this.dispatchEvent(new ByteEvent(e,t,s))}dispatchEvent(e){try{if((0,__2.isDev)()&&"object"==typeof e.payload)if((0,misc_1.findCircular)(e.payload))return void this.byteboost.error("unable to dispatch event. payload has circular properties -> new byte event:",e);var t=e.copy();t.payload._eventId=t.eventId,this.state.eventQueue.push(t)}catch(e){this.byteboost.error("Error on dispatch",e)}}listen(e,t,s){null!=this.state.eventListeners&&(e=toByteId(e,t),this.state.eventListeners.hasOwnProperty(e)?this.state.eventListeners[e].push(s):this.state.eventListeners[e]=[s])}getNextEvent(){return this.state.eventQueue[0]}removeNextEvent(){return this.state.eventQueue.shift()}before(e){let t=!0;for(var s of this.middlewares.before)if(!1===s(e)){t=!1;break}return t}addModulePolling(e){this.modulesToPoll.push(e)}enginePoll(){for(var e of this.modulesToPoll)e.onPoll()}after(e){}async sleep(t){await new Promise(e=>{setTimeout(()=>{e()},t)})}runEventContext(){let n=this.state.eventQueue.slice();const e=()=>{if(0===n.length)return null;let t=n[n.length-1],s=n.length-1;for(let e=0;e<n.length;e++)n[e].priority>t.priority&&(t=n[e],s=e);return n.splice(s,1),this.before(t)?t:e()};let t=e();var s;t&&(-1===(s=this.state.eventQueue.findIndex(e=>e.eventId===t.eventId))?this.byteboost.error("Unable to find event in event queue",t):(this.state.eventQueue.splice(s,1),this.state.processingEvents.push(t)))}dispatchNextProcessedEvent(){if(0===this.state.processingEvents.length)return null;var e,t=this.state.processingEvents[0];if(!(t.id in this.state.eventListeners)||0===this.state.eventListeners[t.id].length)return this.byteboost.warn("no listeners found for event:",t),null;this.byteboost.debug("dispatching event:",t);for(e of this.state.eventListeners[t.id])e(t.payload);return t._meta={dispatched:Date.now()},this.isGarbageEvent(t)||this.state.handledEvents.push(t.flatten()),this.state.processingEvents.shift(),t}async poll(){var e;await this.sleep(this._poll.current.timeout),this.polling&&(this._poll.current.id++,null==this.state.eventListeners?(this.byteboost.error("[EventBus] No event listeners. Stopping polling"),this.polling=!1):(null!==(e=this.dispatchNextProcessedEvent())&&this.after(e),this.runEventContext(),this.enginePoll(),this.poll()))}declareGarbage(t,s){this._garbage.events.find(e=>t===e.app&&s===e.id)||(this._garbage.events.push({app:t,id:s}),this._garbage.eventsStr.push(toByteId(t,s)))}formatSyncData(){return{handledEvents:(0,misc_1.removeCircular)(this.state.handledEvents)}}onSync(e){if(e.response.success){const t=e.data._syncRequestedAt;this.state.handledEvents=this.state.handledEvents.filter(e=>e._meta.dispatched>t)}else this.byteboost.error("Unable to sync eventBus module.")}removeHandledEvents(t){this.state.handledEvents=this.state.handledEvents.filter(e=>!t.includes(e.eventId))}getHandledEvent(t){if(t)return this.state.handledEvents.find(e=>e.eventId===t)}cleanSyncedData(e,s){if(0===e.length)return e;let n=[];e=e.filter(e=>{var t,e=this.getHandledEvent(e._eventId);return!!e&&((t=!(e._meta.dispatched>s.data._syncRequestedAt))&&n.push(e.eventId),!t)});return this.removeHandledEvents(n),e}boot(){this.polling=!0,this.declareGarbage("request","sync"),this.poll()}cleanup(){this.polling=!1}isGarbageEvent(e){return this._garbage.eventsStr.includes(e.id)}removeGarbageEvents(e){return e.filter(e=>{return!this._garbage.eventsStr.includes(e.id)})}packEventList(e){e=e.slice(),e=(0,misc_1.removeCircular)((0,object_1.cloneObject)(e));return this.removeGarbageEvents(e)}unpackEventList(e){return e&&0!==e.length?e.map(e=>new ByteEvent("","",{}).sharpen(e)):[]}async pack(){var e=this.packEventList(this.state.eventQueue),t=this.packEventList(this.state.processingEvents),s=this.state.handledEvents.slice(),s=(0,misc_1.removeCircular)((0,object_1.cloneObject)(s));return{...this.state,eventListeners:null,eventQueue:e,processingEvents:t,handledEvents:s}}unpack(e){e.eventQueue=this.unpackEventList(e.eventQueue),e.processingEvents=this.unpackEventList(e.processingEvents),e.eventListeners={},super.unpack(e)}build(){return{eventQueue:[],processingEvents:[],eventListeners:{},lastEventId:"",handledEvents:[]}}}exports.EventBus=EventBus;const useValidEvents=e=>{if(!e.isValid()){var t=window._byteboost.getModule("eventBus");if(!t)return window._byteboost.error("Unable to find event bus module"),!1;t.byteboost.warn("Next event is invalid. Removing it",e),t.removeNextEvent()}return!0};
