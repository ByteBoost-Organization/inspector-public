"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.wrapWindow=exports.ByteBoost=exports.BASE_API_URL=void 0;const eventBus_1=require("./modules/eventBus"),logger_1=require("./modules/logger"),request_1=require("./modules/request"),errors_1=require("./modules/errors"),jsonCompressor_1=require("./utils/jsonCompressor"),core_1=require("./modules/core"),preflight_1=require("./preflight"),pinger_1=require("./modules/pinger"),workerHandling_1=require("./workerHandling"),misc_1=require("./misc"),LOG_LEVEL_COLORS=(exports.BASE_API_URL="https://dev.external.api.byteboost.io",{DEBUG:"#5075DA",INFO:"#50DA7C",ERROR:"#DA6550",WARN:"#DAB250"}),PERSISTANT_DATA_KEY="__byteboost.io__persistant_data",PERSISTANT_DATA_KEY_MAPPING=PERSISTANT_DATA_KEY+"_m",modulesToLoad=[eventBus_1.EventBus,request_1.RequestModule,logger_1.Logger,errors_1.ErrorModule,core_1.Core,pinger_1.Pinger];class ByteBoost{modules;performance;navigator;initializedAt=0;apiKey;obfuscateLevel;doFullByteBoostRestart;constructor(e){this.info("starting"),this.obfuscateLevel=e.obfuscateLevel,this.doFullByteBoostRestart=e.startByteboost,this.navigator=window.navigator,this.performance=window.performance||self.performance,this.apiKey=e.apiKey;let o=this.getPersistantData();!1===o&&(o={}),this.modules={};for(var t of modulesToLoad){t=new t;o.hasOwnProperty(t.namespace)?t.unpack(o[t.namespace]):t.onBuildNeeded(),this.modules[t.namespace]={namespace:t.namespace,module:t}}window.addEventListener("beforeunload",onUnloadListener)}initializeModules(){for(var e in this.debug("initializing modules"),this.modules)"eventBus"!==e&&this.modules[e].module.bindEventBus(this.getModule("eventBus")),this.modules[e].module.boot();this.initializedAt=Date.now()}getModule(e){if(this.modules[e])return this.modules[e].module}getApiKey(){return this.apiKey}debug(...e){console.log("%c[byteboost]","color:"+LOG_LEVEL_COLORS.DEBUG+";font-weight:bold;",...e)}info(...e){console.log("%c[byteboost]","color:"+LOG_LEVEL_COLORS.INFO+";font-weight:bold;",...e)}warn(...e){console.log("%c[byteboost]","color:"+LOG_LEVEL_COLORS.WARN+";font-weight:bold;",...e)}error(...e){console.log("%c[byteboost]","color:"+LOG_LEVEL_COLORS.ERROR+";font-weight:bold;",...e)}async compilePersistantData(){var e,o={};for(e in this.modules){var t=await this.modules[e].module.pack();o[e]=t}return o}async purge(){await this.cleanup(),localStorage.removeItem(PERSISTANT_DATA_KEY),localStorage.removeItem(PERSISTANT_DATA_KEY_MAPPING),this.doFullByteBoostRestart()}async forceReload(){await this.cleanup(),this.doFullByteBoostRestart()}getPersistantData(){try{var e=JSON.parse((0,misc_1.uncompressString)(localStorage.getItem(PERSISTANT_DATA_KEY))),o=JSON.parse(localStorage.getItem(PERSISTANT_DATA_KEY_MAPPING)),t=Date.now(),s=(0,jsonCompressor_1.uncompressJSON)(e,o);if(this.debug("Uncompression took:",Date.now()-t,"ms"),s)return s;throw"unable to compress"}catch(e){return!1}}async cleanup(){for(var e in this.debug("cleaning up"),this.modules){e=this.modules[e].module;e.cleanup(),"isDataModule"in e&&e.forceSend()}var o=await this.compilePersistantData(),t=Date.now(),[o,s]=(0,jsonCompressor_1.compressJSON)(o),t=(this.debug("Compression took:",Date.now()-t,"ms"),JSON.stringify(o)),o=JSON.stringify(s),t=(0,misc_1.compressString)(t);try{localStorage.setItem(PERSISTANT_DATA_KEY,t),localStorage.setItem(PERSISTANT_DATA_KEY_MAPPING,o)}catch(e){this.error("Unable to save data to local storage",e)}window.removeEventListener("beforeunload",onUnloadListener),this.info("terminated"),this.info("informing backend"),fetch(exports.BASE_API_URL+"/v1beta/session/kill",{credentials:"include",headers:{"X-Auth-Token":window.byteboostKey??""}}),window._byteboost&&delete window._byteboost}getObfuscateLevel(){return this.obfuscateLevel}}exports.ByteBoost=ByteBoost;const onUnloadListener=async()=>{await window._byteboost.cleanup()},wrapWindow=()=>{if("undefined"!=typeof window&&!window._byteboost&&!window._startingByteboost){const o=async()=>{await(0,workerHandling_1.setupPersistantWorkers)();var e=await(0,preflight_1.preflightChecks)();!1!==e&&e?(console.log("Preflight succeded!"),window._byteboost=new ByteBoost({apiKey:window.byteboostKey,startByteboost:o,obfuscateLevel:e.obfuscateLevel}),window._byteboost.initializeModules()):(console.log("Preflight failed"),await(0,workerHandling_1.killPersistantWorkers)())};try{console.log("starting byteboost"),o()}catch(e){}}};exports.wrapWindow=wrapWindow,(0,exports.wrapWindow)();
